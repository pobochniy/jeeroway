# Настройка секретов для деплоя API

## Обзор решения

Используется подход с **GitHub Secrets** для максимальной безопасности и удобства управления.

### Преимущества:
- ✅ Секреты не хранятся на VM
- ✅ Автоматизированный rollback через GitHub Actions
- ✅ Полный аудит всех изменений
- ✅ Легкая ротация секретов
- ✅ Защита от компрометации VM

## Шаг 1: Добавление секрета в GitHub

1. Перейдите в репозиторий на GitHub
2. Settings → Secrets and variables → Actions
3. Нажмите **New repository secret**
4. Добавьте секрет:
   - **Name**: `API_DB_CONNECTION_STRING`
   - **Value**: ваша строка подключения к БД
   
   Пример значения:
   ```
   Server=jeerowaydbcontainer;Port=3306;Database=jeerowaydb;User=app;Password=your_secure_password;
   ```

## Шаг 2: Как работает деплой

### Обычный деплой (publish-api.yml)
```bash
# В GitHub Actions → Actions → Publish Api → Run workflow
```

Workflow автоматически:
1. Собирает приложение
2. Создает Docker образ с меткой по дате (например, `2026_01_13__11_30_45`)
3. Останавливает старый контейнер
4. Запускает новый контейнер с секретом из GitHub
5. Помечает образ как `latest`
6. **Удаляет старые образы, оставляя только 5 последних версий**

### Откат на предыдущую версию (rollback-api.yml)
```bash
# В GitHub Actions → Actions → Rollback Api → Run workflow
```

Опции отката:
- **previous** (по умолчанию) - откатиться на предыдущую версию
- **latest** - откатиться на последнюю стабильную версию
- **2026_01_13__10_30_45** - откатиться на конкретную версию

### Просмотр и очистка версий (list-api-versions.yml)
```bash
# В GitHub Actions → Actions → List Api Versions → Run workflow
```

Показывает:
- Все доступные версии образов
- Текущую запущенную версию
- Дату создания и размер образов

Затем автоматически:
- **Удаляет старые образы, оставляя только 5 последних версий**
- Защищает текущую запущенную версию от удаления
- Всегда сохраняет образ с тегом `latest`

## Шаг 3: Как ASP.NET Core читает секрет

ASP.NET Core автоматически заменяет `__` (двойное подчеркивание) на `:` в переменных окружения.

Переменная окружения:
```bash
ConnectionStrings__AppConnection="Server=..."
```

Читается как:
```json
{
  "ConnectionStrings": {
    "AppConnection": "Server=..."
  }
}
```

## Безопасность

### ✅ Что защищено:
- Секреты не хранятся в коде
- Секреты не хранятся на VM в виде файлов
- При компрометации VM злоумышленник не получит строку подключения
- Секреты передаются только во время выполнения workflow

### ⚠️ Что нужно учитывать:
- Секрет виден в переменных окружения контейнера (`docker inspect japi`)
- Если злоумышленник получит root доступ к VM, он сможет увидеть env контейнера
- Для максимальной защиты используйте Docker Secrets или Vault (более сложная настройка)

## Ротация секретов

1. Измените пароль в БД
2. Обновите секрет `API_DB_CONNECTION_STRING` в GitHub
3. Запустите `Publish Api` или `Rollback Api` workflow
4. Новый контейнер получит обновленный секрет

## Альтернативные подходы

### Вариант 1: ENV на VM (не рекомендуется)
```bash
# На VM
export ConnectionStrings__AppConnection="Server=..."
```
- ❌ Секрет хранится на VM
- ✅ Простой rollback
- ❌ Нет аудита изменений

### Вариант 2: Docker Secrets (для Docker Swarm)
Требует настройки Docker Swarm, более сложная конфигурация.

### Вариант 3: HashiCorp Vault
Максимальная безопасность, но требует отдельного сервиса и сложной настройки.

## Управление дисковым пространством

### Автоматическая очистка
Используется переиспользуемый workflow `cleanup-old-images.yml`, который вызывается из:
- `publish-api.yml` - после каждого деплоя
- `list-api-versions.yml` - при ручном запуске

Логика очистки:
- ✅ Сохраняются только **5 последних версий**
- ✅ Всегда сохраняется образ с тегом `latest`
- ✅ Текущая запущенная версия защищена от удаления
- ✅ Можно настроить количество сохраняемых версий через параметр `keep_versions`

### Ручная очистка (если нужно)
```bash
# Удалить все образы кроме последних 5
docker images jeeroway-api --format "{{.Tag}}" | grep -v "latest" | tail -n +6 | xargs -I {} docker rmi jeeroway-api:{}

# Удалить все неиспользуемые образы Docker
docker image prune -a

# Посмотреть использование диска
docker system df
```

### Почему 5 версий?
- **1 версия** - текущая (running)
- **4 версии** - для быстрого отката на предыдущие стабильные версии
- Средний размер образа: ~200-300 MB
- Итого: ~1-1.5 GB дискового пространства

### Использование в других проектах
Переиспользуемый workflow `cleanup-old-images.yml` можно использовать для любых Docker образов:

```yaml
jobs:
  cleanup:
    uses: ./.github/workflows/cleanup-old-images.yml
    with:
      image_name: my-app        # Имя образа
      keep_versions: 5          # Количество версий (по умолчанию 5)
      container_name: my-container  # Имя контейнера для защиты (опционально)
```

### Структура workflows
```
.github/workflows/
├── publish-api.yml           # Деплой API (запускаемый вручную)
├── rollback-api.yml          # Откат на предыдущую версию (запускаемый вручную)
├── list-api-versions.yml     # Просмотр и очистка версий (запускаемый вручную)
└── cleanup-old-images.yml    # Переиспользуемый workflow (вызывается другими)
```

## Рекомендации

1. **Используйте сильные пароли** для БД
2. **Ограничьте права пользователя БД** - только необходимые таблицы
3. **Регулярно ротируйте секреты** (раз в 3-6 месяцев)
4. **Настройте firewall** на VM - доступ к БД только с localhost
5. **Включите логирование** неудачных попыток подключения к БД
6. **Используйте SSL/TLS** для подключения к БД если возможно
7. **Мониторьте дисковое пространство** - запускайте `List Api Versions` периодически

## Troubleshooting

### Контейнер не запускается после деплоя
```bash
# Проверьте логи
docker logs japi

# Проверьте переменные окружения
docker inspect japi | grep -A 10 "Env"
```

### Нужно посмотреть все версии образов
```bash
# На VM
docker images jeeroway-api
```

### Нужно вручную запустить конкретную версию
```bash
# На VM
docker stop japi && docker rm japi
docker run --restart unless-stopped -p 5000:5050 -d --name japi --network nginx-proxy-man \
  --env ASPNETCORE_ENVIRONMENT=Release \
  --env ConnectionStrings__AppConnection="YOUR_CONNECTION_STRING" \
  jeeroway-api:2026_01_13__10_30_45
```

**⚠️ Внимание**: При ручном запуске вам нужно будет вручную ввести строку подключения.
