name: Publish Angular

on:
  workflow_dispatch:

env:
  ANGULAR_PROJECT_PATH: src/Jeeroway.Web/web
  BUILD_OUTPUT_PATH: src/Jeeroway.Web/web/dist/web/browser
  DEPLOY_DIR: ~/frontend
  BACKUP_DIR: ~/frontend-backup

jobs:
  build-and-deploy:
    runs-on: [self-hosted, jeeroway-vm]
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      - name: Install dependencies üì¶
        working-directory: ${{ env.ANGULAR_PROJECT_PATH }}
        run: npm ci

      - name: Build Angular for production üèóÔ∏è
        working-directory: ${{ env.ANGULAR_PROJECT_PATH }}
        run: npm run build -- --configuration production

      - name: Backup previous version üíæ
        run: |
          # –û—á–∏—â–∞–µ–º –ø–∞–ø–∫—É –±—ç–∫–∞–ø–∞
          if [ -d "${{ env.BACKUP_DIR }}" ]; then
            rm -rf ${{ env.BACKUP_DIR }}/*
            echo "Cleared ${{ env.BACKUP_DIR }}"
          else
            mkdir -p ${{ env.BACKUP_DIR }}
            echo "Created ${{ env.BACKUP_DIR }}"
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –≤ –±—ç–∫–∞–ø, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -d "${{ env.DEPLOY_DIR }}" ] && [ "$(ls -A ${{ env.DEPLOY_DIR }})" ]; then
            cp -r ${{ env.DEPLOY_DIR }}/* ${{ env.BACKUP_DIR }}/
            echo "Backed up current version to ${{ env.BACKUP_DIR }}"
          else
            echo "No previous version to backup"
          fi

      - name: Clear frontend directory üßπ
        run: |
          if [ -d "${{ env.DEPLOY_DIR }}" ]; then
            rm -rf ${{ env.DEPLOY_DIR }}/*
            echo "Cleared ${{ env.DEPLOY_DIR }}"
          else
            mkdir -p ${{ env.DEPLOY_DIR }}
            echo "Created ${{ env.DEPLOY_DIR }}"
          fi

      - name: Deploy built files üöÄ
        run: |
          cp -r ${{ env.BUILD_OUTPUT_PATH }}/* ${{ env.DEPLOY_DIR }}/
          echo "Deployed files to ${{ env.DEPLOY_DIR }}"

      - name: Verify deployment ‚úÖ
        run: |
          echo "Files in ${{ env.DEPLOY_DIR }}:"
          ls -la ${{ env.DEPLOY_DIR }}
          echo ""
          echo "Backup files in ${{ env.BACKUP_DIR }}:"
          ls -la ${{ env.BACKUP_DIR }}
          echo ""
          echo "‚ÑπÔ∏è  To rollback to previous version, run:"
          echo "   rm -rf ${{ env.DEPLOY_DIR }}/* && cp -r ${{ env.BACKUP_DIR }}/* ${{ env.DEPLOY_DIR }}/"
