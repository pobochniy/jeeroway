<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeeroway Viewer</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header { padding: 12px 16px; border-bottom: 1px solid #ccc3; display: flex; gap: 12px; align-items: center; }
    main { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr; }
    .row { display: grid; gap: 16px; grid-template-columns: 1fr 1fr; }
    .card { border: 1px solid #ccc3; border-radius: 8px; overflow: hidden; }
    .card header { font-weight: 600; }
    .card header, .card .body { padding: 12px; }
    img.stream { width: 100%; height: auto; background: #000; object-fit: contain; aspect-ratio: 16/9; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    select, button { padding: 8px 10px; border-radius: 6px; border: 1px solid #8885; background: inherit; color: inherit; }
    button.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    button.secondary { background: #4b5563; color: #fff; border-color: #4b5563; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <header>
    <div>Jeeroway Viewer</div>
    <div class="controls">
      <button id="btnStart" class="primary" title="POST /video/start-recording">Start recording</button>
      <button id="btnStop" class="secondary" title="POST /video/stop-recording">Stop recording</button>
      <span>Current session: <small id="currentSession" class="mono">-</small></span>
    </div>
  </header>
  <main>
    <div class="row">
      <div class="card">
        <header>Live stream</header>
        <div class="body">
          <img id="liveStream" class="stream" alt="Live stream" src="/video/live.mjpeg" />
        </div>
      </div>
      <div class="card">
        <header>Recorded sessions</header>
        <div class="body">
          <div class="controls">
            <select id="sessionSelect"></select>
            <button id="btnRefresh">Refresh list</button>
          </div>
          <div style="margin-top:12px">
            <img id="sessionStream" class="stream" alt="Session stream" />
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const el = id => document.getElementById(id);

    async function api(path, options) {
      const res = await fetch(path, options);
      if (!res.ok) throw new Error(`${options?.method || 'GET'} ${path} -> ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      return res.text();
    }

    async function loadSessions(selectFirst = false) {
      const list = await api('/video/sessions');
      const sel = el('sessionSelect');
      sel.innerHTML = '';
      for (const s of list) {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        sel.appendChild(opt);
      }
      if (selectFirst && list.length > 0) sel.value = list[list.length - 1];
      updateSessionStream();
    }

    function updateSessionStream() {
      const id = el('sessionSelect').value;
      const img = el('sessionStream');
      if (!id) { img.removeAttribute('src'); return; }
      // Bust caching by appending a noop changing query when re-selecting
      img.src = `/video/sessions/${encodeURIComponent(id)}/mjpeg`;
    }

    async function loadCurrentSession() {
      try {
        const data = await api('/video/current-session');
        el('currentSession').textContent = data.sessionId || '-';
      } catch (e) {
        el('currentSession').textContent = '-';
      }
    }

    async function startRecording() {
      try {
        const res = await api('/video/start-recording', { method: 'POST' });
        await loadCurrentSession();
        await loadSessions();
      } catch (e) { alert(e.message); }
    }

    async function stopRecording() {
      try {
        await api('/video/stop-recording', { method: 'POST' });
        await loadCurrentSession();
        await loadSessions();
      } catch (e) { alert(e.message); }
    }

    function wireUi() {
      el('btnStart').addEventListener('click', startRecording);
      el('btnStop').addEventListener('click', stopRecording);
      el('btnRefresh').addEventListener('click', () => loadSessions(false));
      el('sessionSelect').addEventListener('change', updateSessionStream);
    }

    async function init() {
      wireUi();
      await loadCurrentSession();
      await loadSessions(true);
      // Ensure live stream restarts if connection breaks
      const live = el('liveStream');
      live.addEventListener('error', () => { setTimeout(() => { live.src = '/video/live.mjpeg'; }, 1000); });
    }

    init();
  </script>
</body>
</html>
